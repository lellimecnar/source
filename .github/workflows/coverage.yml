name: Coverage

on:
  pull_request:
    branches: [master, main]

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.2

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm --filter "@card-stack/*" test -- --coverage --coverageReporters=json-summary --coverageReporters=text

      - name: Generate coverage summary
        id: coverage
        run: |
          # Extract coverage from card-stack/core
          if [ -f "card-stack/core/coverage/coverage-summary.json" ]; then
            CORE_COVERAGE=$(node -e "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('card-stack/core/coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              console.log(JSON.stringify({
                lines: total.lines.pct,
                statements: total.statements.pct,
                functions: total.functions.pct,
                branches: total.branches.pct
              }));
            ")
            echo "core_coverage=$CORE_COVERAGE" >> $GITHUB_OUTPUT
          fi

          # Extract coverage from card-stack/deck-standard
          if [ -f "card-stack/deck-standard/coverage/coverage-summary.json" ]; then
            DECK_COVERAGE=$(node -e "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('card-stack/deck-standard/coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              console.log(JSON.stringify({
                lines: total.lines.pct,
                statements: total.statements.pct,
                functions: total.functions.pct,
                branches: total.branches.pct
              }));
            ")
            echo "deck_coverage=$DECK_COVERAGE" >> $GITHUB_OUTPUT
          fi

      - name: Comment coverage on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const coreCoverage = ${{ steps.coverage.outputs.core_coverage || '{}' }};
            const deckCoverage = ${{ steps.coverage.outputs.deck_coverage || '{}' }};

            let comment = '## ðŸ“Š Test Coverage Report\n\n';

            if (Object.keys(coreCoverage).length > 0) {
              comment += '### @card-stack/core\n';
              comment += '| Metric | Coverage |\n';
              comment += '|--------|----------|\n';
              comment += `| Lines | ${coreCoverage.lines}% |\n`;
              comment += `| Statements | ${coreCoverage.statements}% |\n`;
              comment += `| Functions | ${coreCoverage.functions}% |\n`;
              comment += `| Branches | ${coreCoverage.branches}% |\n\n`;
            }

            if (Object.keys(deckCoverage).length > 0) {
              comment += '### @card-stack/deck-standard\n';
              comment += '| Metric | Coverage |\n';
              comment += '|--------|----------|\n';
              comment += `| Lines | ${deckCoverage.lines}% |\n`;
              comment += `| Statements | ${deckCoverage.statements}% |\n`;
              comment += `| Functions | ${deckCoverage.functions}% |\n`;
              comment += `| Branches | ${deckCoverage.branches}% |\n\n`;
            }

            comment += '_Coverage reports generated by Jest_';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
